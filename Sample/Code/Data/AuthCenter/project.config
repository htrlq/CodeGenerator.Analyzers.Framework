<?xml version="1.0" encoding="utf-8"?>
<SQLConfig xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
	<SQLList>
		
		<!-- 新建项目-->
		<SQL SQLKey="project.Insert" ConnectionKey="MainWrite">
			<Text>
				<![CDATA[
				INSERT INTO project (
					`SysCode`,
					`ProjectName`,
					`ProjectShortName`,
					`ProjectDescription`,
					`OrganizationSysCode`,
					`OrganizationCode`,
					`ConstructionSites`,
					`ContactName`,
					`ContactPhone`,
					`ContactEmail`,
					`ContactAddress`,
					`InUserSysNo`,
					`InUserName`,
					`InDate`,
					`EditUserSysNo`,
					`EditUserName`,
					`EditDate`,
					`Memo` 
				)
				VALUES
					(
						@SysCode,
						@ProjectName,
						@ProjectShortName,
						@ProjectDescription,
						@OrganizationSysCode,
						@OrganizationCode,
						@ConstructionSites,
						@ContactName,
						@ContactPhone,
						@ContactEmail,
						@ContactAddress,
						@InUserSysNo,
						@InUserName,
						NOW(3),
						@EditUserSysNo,
						@EditUserName,
						NOW(3),
						@Memo 
					);
				SELECT @@IDENTITY;
				]]>
			</Text>
		</SQL>
		
		<!-- 设置项目管理员-->
		<SQL SQLKey="project.SetProjectAdmin" ConnectionKey="MainWrite">
			<Text>
				<![CDATA[
				UPDATE 
					project
				SET
					`EditUserSysNo`=@EditUserSysNo,
					`EditUserName`=@EditUserSysNo,
					`EditDate`=NOW(3),
					AdminLoginName=@AdminLoginName,
					AdminSysCode=@AdminSysCode
				Where SysCode=@SysCode;
				]]>
			</Text>
		</SQL>
		 
		<!-- 检查项目名称是否存在 -->
		<SQL SQLKey="project.CheckProjectNameExits" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
				  COUNT(1)
				FROM
					project s
				WHERE
					s.CommonStatus != -999
					AND s.ProjectName = @ProjectName
					#{ AND s.SysCode != @SysCode }
				]]>
			</Text>
		</SQL>
		<!-- 根据syscode获取项目-->
		<SQL SQLKey="project.GetProjectBySysCode" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
					s.SysNo,
					s.SysCode,
					s.AdminLoginName,
					s.AdminSysCode,
					s.ProjectName,
					s.ProjectShortName,
					s.ProjectDescription,
					s.ContactAddress,
					s.OrganizationSysCode,
					s.OrganizationCode,
					s.ConstructionSites,
					s.ProjectStatus,
					s.ContactName,
					s.ContactPhone,
					s.ContactEmail,
					s.ContactAddress,
					s.Memo,
					s.CommonStatus
				FROM
					project s
				WHERE
				  s.CommonStatus != -999
					AND s.SysCode = @SysCode
				]]>
			</Text>
		</SQL>
		<!-- 根据sysno获取项目-->
		<SQL SQLKey="project.GetProjectBySysNo" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
					s.SysNo,
					s.SysCode,
					s.AdminLoginName,
					s.AdminSysCode,
					s.ProjectName,
					s.ProjectShortName,
					s.ProjectDescription,
					s.ContactAddress,
					s.OrganizationSysCode,
					s.OrganizationCode,
					s.ConstructionSites,
					s.ProjectStatus,
					s.ContactName,
					s.ContactPhone,
					s.ContactEmail,
					s.ContactAddress,
					s.Memo,
					s.CommonStatus
				FROM
					project s
				WHERE
				  s.CommonStatus != -999
					AND s.SysNo = @SysNo
				]]>
			</Text>
		</SQL>


		<!-- 分页查询项目列表 -->
		<SQL SQLKey="project.LoadProjectList" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
			  SELECT
					b.SysNo,
					b.SysCode,
					b.ProjectName,
					b.ProjectShortName,
					b.ProjectDescription,
					b.ConstructionSites,
					b.CommonStatus,
					b.ProjectStatus,
					b.OrganizationSysCode,
					c.OrganizationCode,
					c.OrganizationName 
			  FROM
		        project b
				  	INNER JOIN organization c ON b.OrganizationSysCode = c.SysCode
			  WHERE
			        b.CommonStatus = 1 AND b.ProjectStatus = 1
			        #{ AND c.OrganizationCode LIKE CONCAT(@OrganizationCode,'%') }
					#{ AND (b.ProjectName LIKE CONCAT('%',@Keywords,'%') OR b.SysNo = @Keywords) }
					#{ AND b.SysNo = @ProjectSysNo }
			  ORDER BY
	            b.SysNo DESC
		          ]]>
			</Text>
		</SQL>

		<!-- 分页查询用户项目列表 -->
		<SQL SQLKey="project.QueryUserProjectList" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
			  SELECT
							b.SysNo,
							b.SysCode,
							b.ProjectName,
							b.ProjectShortName,
							b.ProjectDescription,
							b.OrganizationSysCode,
							b.OrganizationCode,
							b.ConstructionSites,
							b.CommonStatus,
							b.ProjectStatus
			  FROM
		          Project b
	            LEFT JOIN project_user pu ON b.SysCode = pu.ProjectSysCode 
			  WHERE
			        b.CommonStatus = 1 
							AND b.ProjectStatus = 1
							#{ AND (b.ProjectName LIKE CONCAT('%',@Keywords,'%') OR b.SysNo = @Keywords) }
							#{ AND ( pu.UserSysCode = @UserSysCode OR b.AdminSysCode = @UserSysCode ) }
			  ORDER BY
	            b.SysNo DESC
		          ]]>
			</Text>
		</SQL>

		<!--查询用户有权限的项目编号列表-->
		<SQL SQLKey="project.GetUserProjectSysNoList" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
					p.SysNo
				FROM
			  	project p
					LEFT JOIN project_user pu ON p.SysCode = pu.ProjectSysCode 
				WHERE
					p.CommonStatus = 1
					#{ AND ( pu.UserSysCode = @UserSysCode OR p.AdminSysCode = @UserSysCode ) }
					#{ AND p.SysNo = @ProjectSysNo }
				 ]]>
			</Text>
		</SQL>

		<!--查询用户所在组织有权限的项目编号列表-->
		<SQL SQLKey="project.GetOrgProjectSysNoList" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
					b.SysNo 
				FROM
					project b
					INNER JOIN organization c ON b.OrganizationSyscode = c.SysCode 
				WHERE
					b.CommonStatus = 1 
					AND c.OrganizationCode LIKE CONCAT(@organizationCode,'%')
				 ]]>
			</Text>
		</SQL>

		<!-- 分页查询组织下项目列表 -->
		<SQL SQLKey="project.GetOrgProjectApiAppList" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
			   SELECT
					IFNULL(project_app.InstallDate,NOW( 3 )) AS SortInstallDate,
					project.SysNo AS ProjectSysNo,
					project.SysCode AS ProjectSysCode,
					project.CommonStatus AS ProjectCommonStatus,
					project.ProjectStatus,
					organization.OrganizationName,
					organization.OrganizationCode,
					project.ProjectName,
					project.ProjectShortName,
					project.OrganizationSysCode,
					project.ConstructionSites,
					api_app.AppId,
					api_app.AppKey,
					api_app.CommonStatus,
					project_app.SysNo AS ProjectApiAppSysNo,
					api_app.SysNo AS ApiAppSysNo,
					project_app.InstallDate,
					project.AdminSysCode,
					project.AdminLoginName 
			FROM
				project project
				INNER JOIN organization organization ON organization.SysCode = project.OrganizationSysCode
				LEFT JOIN project_api_app project_app ON project_app.ProjectSysCode = project.SysCode
				LEFT JOIN api_app api_app ON project_app.ApiAppSysCode = api_app.SysCode 
			WHERE
				project.CommonStatus = 1 
				AND project.ProjectStatus = 1 
				AND ( api_app.CommonStatus != - 999 OR api_app.CommonStatus IS NULL ) 
				#{ AND project.OrganizationCode LIKE CONCAT(@OrganizationCode,'%') }
				#{ AND (project.ProjectName LIKE CONCAT('%',@Keywords,'%') OR project.SysNo = @Keywords) }
			ORDER BY
				SortInstallDate DESC,
				project.SysNo DESC
		          ]]>
			</Text>
		</SQL>

		<!-- 开通项目授权码 -->
		<SQL SQLKey="project.EnableAuthorizeCode" ConnectionKey="MainWrite">
			<Text>
				<![CDATA[
				
				INSERT INTO api_app (`SysCode`, `AppId`, `AppKey`, `Desc`, `Data`, AppType, CommonStatus ,InUserSysNo, InUserName,InDate, EditUserSysNo, EditUserName,EditDate )
					VALUES
				(@SysCode, CONCAT("ers_",MD5(uuid())), replace(uuid(), '-', ''), '开通授权码', CONCAT('{"ProjectSysNo":',@ProjectSysNo,'}'), 3, 1,@InUserSysNo,@InUserName,NOW(3), @EditUserSysNo, @EditUserName,NOW(3) );
	
	
				INSERT INTO project_api_app 
				(ApiAppSysCode,ProjectSysCode,InUserSysNo, InUserName,InDate, EditUserSysNo, EditUserName,EditDate )
				VALUES
				( @SysCode, @ProjectSysCode,@InUserSysNo,@InUserName,NOW(3), @EditUserSysNo, @EditUserName,NOW(3)  );
				
				SELECT @@IDENTITY;
		          ]]>
			</Text>
		</SQL>

		<!-- 新增项目用户 -->
		<SQL SQLKey="projectUser.Insert" ConnectionKey="MainWrite">
			<Text>
				<![CDATA[
				
				INSERT INTO `project_user` (
					`ProjectSysCode`,
					`UserSysCode`,
					`InUserSysNo`,
					`InUserName`,
					`InDate`,
					`EditUserSysNo`,
					`EditUserName`,
					`EditDate`,
					`Memo` 
				)
				VALUES
					(
						@ProjectSysCode,
						@UserSysCode,
						@InUserSysNo,
						@InUserName,
						NOW(3),
						@EditUserSysNo,
						@EditUserName,
						NOW(3),
						@Memo
					);

				SELECT @@IDENTITY;
				]]>
			</Text>
		</SQL>
		
		<!-- 查询项目用户 -->
		<SQL SQLKey="systeUser.QueryProjectUserList" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
					s.SysNo,
					s.SysCode,
					s.LoginName,
					s.UserFullName,
					s.Gender,
					s.ContactPhone,
					s.ContactEmail,
					s.AvatarImageUrl,
					s.LastLoginTime,
					s.LastChangePasswordDate,
					s.LoginTimes,
					s.UserType,
					s.Memo,
					s.CommonStatus 
				FROM
					`system_user` s
					INNER JOIN project_user pu ON pu.UserSysCode = s.SysCode 
				WHERE
					s.CommonStatus != - 999  AND s.UserType=@UserType
					AND pu.ProjectSysCode = @ProjectSysCode
					#{ AND s.CommonStatus=@CommonStatus }
					#{ AND (s.LoginName LIKE CONCAT( '%', @Keywords, '%' ) OR s.UserFullName LIKE CONCAT( '%', @Keywords, '%' )) }
				ORDER BY
					s.SysNo DESC
				]]>
			</Text>
		</SQL>

		<!-- 获取用户项目信息-->
		<SQL SQLKey="project.GetUserProjects" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
					s.SysNo,
					s.SysCode,
					s.AdminLoginName,
					s.AdminSysCode,
					s.ProjectName,
					s.ProjectShortName,
					s.ProjectDescription,
					s.OrganizationSysCode,
					s.OrganizationCode,
					s.ConstructionSites,
					s.ProjectStatus,
					s.ContactName,
					s.ContactPhone,
					s.ContactEmail,
					s.ContactAddress,
					s.InUserName,
					s.InDate,
					s.Memo,
					s.CommonStatus 
				FROM
					project s
					LEFT JOIN project_user pu ON pu.ProjectSysCode = s.SysCode 
				WHERE
					s.CommonStatus = 1 
					AND ( pu.UserSysCode = @UserSysCode OR s.AdminSysCode = @UserSysCode ) 
					#{ AND s.SysCode = @ProjectSysCode }
					#{ AND s.SysNo = @ProjectSysNo }
				ORDER BY
					s.SysNo DESC
				]]>
			</Text>
		</SQL>

		<!-- 插入项目授权码 -->
		<SQL SQLKey="project.api_app.insert" ConnectionKey="MainWrite">
			<Text>
				<![CDATA[
				
				INSERT INTO api_app (`SysNo`,`SysCode`, `AppId`, `AppKey`, `Desc`, `Data`, AppType, CommonStatus ,InUserSysNo, InUserName,InDate, EditUserSysNo, EditUserName,EditDate )
					VALUES
				(@ApiAppSysNo,@SysCode, @AppId, @AppKey, '开通授权码', CONCAT('{"ProjectSysNo":',@ProjectSysNo,'}'), 3, 1,@InUserSysNo,@InUserName,@InDate, @EditUserSysNo, @EditUserName,NOW(3) );

	
				INSERT INTO project_api_app 
				(ApiAppSysNo,ApiAppSysCode,ProjectSysNo,InUserSysNo,InUserName,InDate, EditUserSysNo, EditUserName,EditDate )
				VALUES
				(@ApiAppSysNo,@SysCode,@UserSysNo,@UserLoginName,@ProjectSysNo,@InUserSysNo,@InUserName,@InDate, @EditUserSysNo, @EditUserName,NOW(3)  );
		          ]]>
			</Text>
		</SQL>
	</SQLList>
</SQLConfig>