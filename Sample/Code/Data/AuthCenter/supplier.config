<?xml version="1.0" encoding="utf-8"?>
<SQLConfig xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
	<SQLList>
		<!-- 新增供应商 -->
		<SQL SQLKey="supplier.Insert" ConnectionKey="MainWrite">
			<Text>
				<![CDATA[
				INSERT INTO supplier (
					SysCode,
					AdminLoginName,
					AdminSysCode,
					RegisterNumber,
					SupplierName,
					ContactAddress,
					ContactName,
					ContactPhone,
					ContactEmail,
					ContactWebsite,
					Memo,
					InUserSysNo,
					InUserName,
					InDate,
					EditUserSysNo,
					EditUserName,
					EditDate,
					CommonStatus
				)
				VALUES
					(
					@SysCode,
					@AdminLoginName,
					@AdminSysCode,
					@RegisterNumber,
					@SupplierName,
					@ContactAddress,
					@ContactName,
					@ContactPhone,
					@ContactEmail,
					@ContactWebsite,
					@Memo,
					@InUserSysNo,
					@InUserName,
					NOW( 3 ),
					@EditUserSysNo,
					@EditUserName,
					NOW( 3 ),
					1 
					);
				SELECT @@IDENTITY;
				]]>
			</Text>
		</SQL>
		<!-- 更新供应商 -->
		<SQL SQLKey="supplier.Update" ConnectionKey="MainWrite">
			<Text>
				<![CDATA[
				UPDATE 
					supplier
				SET
					SupplierName=@SupplierName,
					ContactName=@ContactName,
					ContactPhone=@ContactPhone,
					EditUserSysNo=@EditUserSysNo,
					EditUserName=@EditUserName,
					EditDate=NOW(3),
					Memo=@Memo
				Where SysCode=@SysCode;
				]]>
			</Text>
		</SQL>
		<!-- 设置供应商管理员 -->
		<SQL SQLKey="supplier.set_supplier_admin" ConnectionKey="MainWrite">
			<Text>
				<![CDATA[
				UPDATE 
					supplier
				SET
					`EditUserSysNo`=@EditUserSysNo,
					`EditUserName`=@EditUserSysNo,
					`EditDate`=NOW(3),
					AdminLoginName=@AdminLoginName,
					AdminSysCode=@AdminSysCode
				Where SysCode=@SysCode;
				]]>
			</Text>
		</SQL>

		<!-- 启用、禁用供应商-->
		<SQL SQLKey="supplier.switchStatus" ConnectionKey="MainWrite">
			<Text>
				<![CDATA[
				UPDATE 
					supplier 
				SET
					EditUserSysNo=@EditUserSysNo,
					EditUserName=@EditUserName,
					EditDate=NOW(3),
					CommonStatus = (case when CommonStatus = 1 then 0 else 1 end)
				Where SysCode=@SysCode AND CommonStatus != -999;
				]]>
			</Text>
		</SQL>
		<!-- 插入项目、供应商关联表-->
		<SQL SQLKey="supplier.project_supplier.Insert" ConnectionKey="MainWrite">
			<Text>
				<![CDATA[
				INSERT INTO project_supplier (
					SupplierSysCode,
					ProjectSysCode,
					`InUserSysNo`,
					`InUserName`,
					`InDate`,
					`EditUserSysNo`,
					`EditUserName`,
					`EditDate`
				)
				SELECT
					@SupplierSysCode,
					@ProjectSysCode,
					@InUserSysNo,
					@InUserName,
					NOW(3),
					@EditUserSysNo,
					@EditUserName,
					NOW(3)
				FROM dual
				WHERE not exists
				 ( SELECT SysNo from project_supplier WHERE 
				   SupplierSysCode = @SupplierSysCode 
					 AND ProjectSysCode = @ProjectSysCode
					 AND CommonStatus != -999 limit 1
					);
				]]>
			</Text>
		</SQL>
		<!-- 查询供应商 -->
		<SQL SQLKey="supplier.QueryList" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
					s.SysNo,
					s.SysCode,
					s.AdminLoginName,
					s.AdminSysCode,
					s.RegisterNumber,
					s.SupplierName,
					s.ContactAddress,
					s.ContactName,
					s.ContactPhone,
					s.ContactEmail,
					s.ContactWebsite,
					s.Memo,
					s.CommonStatus,
					p.ProjectSysCode
				FROM 
					supplier s
					inner join project_supplier p
					ON s.SysCode = p.SupplierSysCode
				WHERE
					s.CommonStatus != -999
					AND p.CommonStatus = 1
					#{ AND p.ProjectSysCode = @ProjectSysCode }
					#{ AND s.SupplierName LIKE CONCAT('%',@Keywords,'%') }
					#{ AND s.SysCode = @SupplierSysCode }
					#{ AND s.CommonStatus in (@CommonStatusList) }
			  ORDER BY
				  s.SysNo DESC
				]]>
			</Text>
		</SQL>
		<!-- 检查供应商名称是否重复 -->
		<SQL SQLKey="supplier.CheckSupplierNameExits" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
				  COUNT(1)
				FROM
					supplier s
				WHERE
					s.CommonStatus != -999
					AND s.SupplierName = @supplierName
					#{ AND s.SysCode != @supplierSysCode }
				]]>
			</Text>
		</SQL>
		<!-- 查询供应商项目是否存在 -->
		<SQL SQLKey="supplier.CheckSupplierProject" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
				  COUNT(1)
				FROM
					supplier s
					inner join project_supplier ps
					ON s.SysCode = ps.SupplierSysCode
					inner join project p
					ON p.SysCode = ps.ProjectSysCode
				WHERE
					ps.CommonStatus = 1
					AND s.CommonStatus = 1
					AND p.CommonStatus = 1
					#{ AND s.SysCode = @SupplierSysCode }
					#{ AND p.SysCode = @ProjectSysCode }
				]]>
			</Text>
		</SQL>

		<!-- 查询供应商项目列表 -->
		<SQL SQLKey="supplier.GetSupplierProjects" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
				  p.SysNo,
					p.SysCode,
					p.ProjectName,
					p.CommonStatus,
					p.ProjectStatus
				FROM
					project p
					inner join project_supplier ps
					ON p.SysCode = ps.ProjectSysCode
				WHERE
					ps.CommonStatus = 1
					AND p.CommonStatus = 1
					AND ps.SupplierSysCode = @SupplierSysCode
				]]>
			</Text>
		</SQL>

		<!-- 根据syscode查询供应商 -->
		<SQL SQLKey="supplier.GetSupplierBySysCode" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
				  s.SysNo,
					s.SysCode,
					s.AdminLoginName,
					s.AdminSysNo,
					s.RegisterNumber,
					s.SupplierName,
					s.ContactAddress,
					s.ContactName,
					s.ContactPhone,
					s.ContactEmail,
					s.ContactWebsite,
					s.Memo,
					s.CommonStatus
				FROM
					supplier s
				WHERE
					s.CommonStatus != -999
					AND s.SysCode = @SupplierSysCode
				]]>
			</Text>
		</SQL>
		<!-- 新增供应商用户-->
		<SQL SQLKey="supplierUser.Insert" ConnectionKey="MainWrite">
			<Text>
				<![CDATA[
				
				INSERT INTO `supplier_user` (
					`SupplierSysCode`,
					`UserSysCode`,
					`InUserSysNo`,
					`InUserName`,
					`InDate`,
					`EditUserSysNo`,
					`EditUserName`,
					`EditDate`,
					`Memo` 
				)
				VALUES
					(
						@SupplierSysCode,
						@UserSysCode,
						@InUserSysNo,
						@InUserName,
						NOW(3),
						@EditUserSysNo,
						@EditUserName,
						NOW(3),
						@Memo
					);

				SELECT @@IDENTITY;
				]]>
			</Text>
		</SQL>

		<!-- 获取用户供应商信息-->
		<SQL SQLKey="systeUser.GetUserSuppliers" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
					s.SysNo,
					s.SysCode,
					s.AdminLoginName,
					s.AdminSysNo,
					s.AdminSysCode,
					s.RegisterNumber,
					s.SupplierName,
					s.ContactAddress,
					s.ContactName,
					s.ContactPhone,
					s.ContactEmail,
					s.ContactWebsite,
					s.Memo,
					s.CommonStatus 
				FROM
					supplier s
					LEFT JOIN supplier_user su ON s.SysCode = su.SupplierSysCode 
				WHERE
					s.CommonStatus = 1 
					AND ( su.UserSysCode = @UserSysCode OR s.AdminSysCode = @UserSysCode ) 
				ORDER BY
					s.SysNo DESC
				]]>
			</Text>
		</SQL>
	</SQLList>
</SQLConfig>