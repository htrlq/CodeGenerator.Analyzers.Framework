<?xml version="1.0" encoding="utf-8"?>
<SQLConfig xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
	<SQLList>
		<!-- 新增组织-->
		<SQL SQLKey="organization.insert" ConnectionKey="MainWrite">
			<Text>
				<![CDATA[
				
				INSERT INTO `organization` (
						`SysCode`,
						`ParentSysCode`,
						`OrganizationCode`,
						`OrganizationName`,
						`SortIndex`,
						`OrganizationShortName`,
						`ContactName`,
						`ContactPhone`,
						`ContactEmail`,
						`InUserSysNo`,
						`InUserName`,
						`InDate`,
						`EditUserSysNo`,
						`EditUserName`,
						`EditDate`,
						`Memo` 
					)
					VALUES
						(
							@SysCode,
							@ParentSysCode,
							@OrganizationCode,
							@OrganizationName,
							@SortIndex,
							@OrganizationShortName,
							@ContactName,
							@ContactPhone,
							@ContactEmail,
							@InUserSysNo,
							@InUserName,
							NOW(3),
							@EditUserSysNo,
							@EditUserName,
							NOW(3),
							@Memo
						);

				SELECT @@IDENTITY;
				]]>
			</Text>
		</SQL>

		<!-- 查询组织-->
		<SQL SQLKey="organization.queryOrganization" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
				a.`SysNo`,
				a.`SysCode`,
				a.`ParentSysCode`,
				a.`OrganizationCode`,
				LEFT(a.`OrganizationCode`,LENGTH(a.`OrganizationCode`)-4) as `ParentOrganizationCode`,
				a.`OrganizationName`,
				a.`SortIndex`,
				a.`OrganizationShortName`,
				a.`ContactName`,
				a.`ContactPhone`,
				a.`ContactEmail`,
				a.`CommonStatus`,
				a.Memo,
				b.OrganizationCode AS ParentOrganizationCode,
				b.OrganizationName AS ParentOrganizationName
			FROM
				organization a
				LEFT JOIN organization b ON a.ParentSysCode = b.SysCode 
			WHERE
				a.CommonStatus != -999 AND a.ParentSysCode IS NOT NULL
				#{ AND (a.OrganizationName LIKE CONCAT( '%', @Keywords, '%' ) OR a.OrganizationCode LIKE CONCAT( '%', @Keywords, '%' )) }
				AND a.OrganizationCode LIKE CONCAT( @ParentOrganizationCode, '%' )
				ORDER BY ParentOrganizationCode ASC, SortIndex DESC, SysNo ASC
				]]>
			</Text>
		</SQL>
		
		<!-- 通过SysCode查询有效组织-->
		<SQL SQLKey="organization.getOrganizationBySysCode" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT 
					`SysNo`,
					`SysCode`,
					`ParentSysCode`,
					`OrganizationCode`,
					`OrganizationName`,
					`SortIndex`,
					`OrganizationShortName`,
					`ContactName`,
					`ContactPhone`,
					`ContactEmail`,
					`InUserSysNo`,
					`InUserName`,
					`InDate`,
					`EditUserSysNo`,
					`EditUserName`,
					`EditDate`,
					`CommonStatus`,
					`Memo` 
				FROM `organization`
				WHERE
					CommonStatus =1 AND SysCode=@SysCode
				]]>
			</Text>
		</SQL>
	
		<!-- 根据父级SysCode查询OrganizationCode值 -->
		<SQL SQLKey="organization.getOrganizationCodeByParentSysCode" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT 
					OrganizationCode
				FROM `organization`
				WHERE
					ParentSysCode=@ParentSysCode
				ORDER BY OrganizationCode DESC
				LIMIT 1
				]]>
			</Text>
		</SQL>
		
		<!--获取组织结构并返回下级组织数量-->
		<SQL SQLKey="organization.getOrganizationByOrganizationCode" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
					`SysNo`,
					`SysCode`,
					`ParentSysCode`,
					`OrganizationCode`,
					LEFT(`OrganizationCode`,LENGTH(`OrganizationCode`)-4) as `ParentOrganizationCode`,
					`OrganizationName`,
					`SortIndex`,
					`OrganizationShortName`,
					`ContactName`,
					`ContactPhone`,
					`ContactEmail`,
					`CommonStatus`,
					( SELECT count( 1 ) FROM organization c WHERE c.CommonStatus != -999 AND c.ParentSysCode = a.SysCode ) AS `ChildCount` 
				FROM
					`organization` AS a 
				WHERE
					a.CommonStatus != -999 AND a.OrganizationCode = @OrganizationCode
				ORDER BY ParentOrganizationCode ASC, SortIndex DESC, SysNo ASC
				]]>
			</Text>
		</SQL>

		<!-- 搜索组织机构-->
		<SQL SQLKey="organization.getOrganizationTreeByKeyword" ConnectionKey="MainRead">
			<Text>
				
				<![CDATA[
				
				DROP TEMPORARY TABLE
				IF
					EXISTS tmp_Org;
				CREATE TEMPORARY TABLE tmp_Org ( SysNo INT, OrganizationCode CHAR ( 50 ) );
				INSERT INTO tmp_Org SELECT
				SysNo,
				OrganizationCode 
				FROM
					organization AS so 
				WHERE
					so.OrganizationCode LIKE concat( @OrganizationCode, '%' ) 
					AND so.CommonStatus != -999 
					#{ AND ( so.OrganizationName LIKE concat( '%', @Keywords, '%' ) OR so.OrganizationShortName LIKE concat( '%', @Keywords, '%' )) };
				SELECT
					b.SysNo,
					b.SySCode,
					b.ParentSysCode,
					b.OrganizationCode,
					LEFT(b.`OrganizationCode`,LENGTH(b.`OrganizationCode`)-4) as `ParentOrganizationCode`,
					b.OrganizationName,
					b.OrganizationShortName,
					b.SortIndex,
					( SELECT COUNT( 1 ) FROM organization d WHERE d.CommonStatus != -999 AND d.ParentSysCode = b.SysCode #{ AND d.OrganizationName LIKE concat( '%', @Keywords, '%' )) } AS `ChildCount` 
				FROM
					organization b 
				WHERE
					b.CommonStatus != -999 
					#{ AND b.OrganizationCode LIKE CONCAT(@OrganizationCode, '%' ) }
					AND EXISTS (
					SELECT
						1 
					FROM
						tmp_Org c 
					WHERE
						c.OrganizationCode LIKE CONCAT(b.OrganizationCode, '%' )) 
				ORDER BY ParentOrganizationCode ASC, b.SortIndex DESC, b.SysNo ASC;
				DROP TEMPORARY TABLE
				IF
					EXISTS tmp_Org;
				
				]]>
			</Text>

		</SQL>

		<!--分页查询组织结构树-->
		<SQL SQLKey="organization.getOrganizationChildsPage" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
				`SysNo`,
				`SysCode`,
				`ParentSysCode`,
				`OrganizationCode`,
				LEFT(`OrganizationCode`,LENGTH(`OrganizationCode`)-4) as `ParentOrganizationCode`,
				`OrganizationName`,
				`OrganizationShortName`,
				`SortIndex`,
				( SELECT count( 1 ) FROM organization c WHERE c.CommonStatus != -999 AND c.ParentSysCode = a.SysCode ) AS `ChildCount` 
				FROM
					organization a 
				WHERE
					a.ParentSysCode IN ( SELECT SysCode FROM organization b WHERE b.CommonStatus != -999 AND b.OrganizationCode = @OrganizationCode )
					AND a.CommonStatus != -999 
				ORDER BY ParentOrganizationCode ASC, SortIndex DESC, SysNo ASC
				]]>
			</Text>

		</SQL>
		
		
		
		<!-- 更新组织-->
		<SQL SQLKey="organization.update" ConnectionKey="MainWrite">
			<Text>
				<![CDATA[
				UPDATE 
					`organization`
				SET
					OrganizationName=@OrganizationName,
					ParentSysCode=@ParentSysCode,
					SortIndex=@SortIndex,
					OrganizationShortName=@OrganizationShortName,
					ContactName=@ContactName,
					ContactPhone=@ContactPhone,
					ContactEmail=@ContactEmail,
					Memo=@Memo,
					EditUserSysNo=@EditUserSysNo,
					EditUserName=@EditUserName,
					EditDate=NOW(3)
				Where SysCode=@SysCode;
				]]>
			</Text>
		</SQL>
		<!-- 启用禁用组织-->
		<SQL SQLKey="organization.switchStatus" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				UPDATE 
					`organization`
				SET
					CommonStatus=@CommonStatus,
					EditUserSysNo=@EditUserSysNo,
					EditUserName=@EditUserName
				Where SysCode=@SysCode;
				]]>
			</Text>
		</SQL>
		<!-- 检查组织名称是否存在-->
		<SQL SQLKey="organization.checkOrganizationNameIsExits" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
				  COUNT(1)
				FROM
					organization s
				WHERE
					s.CommonStatus != -999
					AND s.OrganizationName = @OrganizationName
					#{ AND s.SysCode != @SysCode }
				]]>
			</Text>
		</SQL>

		<!-- 新增组织用户-->

		<SQL SQLKey="organizationUser.Insert" ConnectionKey="MainWrite">
			<Text>
				<![CDATA[
				
				INSERT INTO `organization_user` (
					`OrganizationSysCode`,
					`UserSysCode`,
					`InUserSysNo`,
					`InUserName`,
					`InDate`,
					`EditUserSysNo`,
					`EditUserName`,
					`EditDate`,
					`Memo` 
				)
				VALUES
					(
						@OrganizationSysCode,
						@UserSysCode,
						@InUserSysNo,
						@InUserName,
						NOW(3),
						@EditUserSysNo,
						@EditUserName,
						NOW(3),
						@Memo
					);

				SELECT @@IDENTITY;
				]]>
			</Text>
		</SQL>

		<!-- 查询组织用户-->	
		<SQL SQLKey="systeUser.QueryOrganizationUserList" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
					s.SysNo,
					s.SysCode,
					s.LoginName,
					s.UserFullName,
					s.Gender,
					s.ContactPhone,
					s.ContactEmail,
					s.AvatarImageUrl,
					s.LastLoginTime,
					s.LastChangePasswordDate,
					s.LoginTimes,
					s.UserType,
					s.IsInitPassword,
					s.Memo,
					s.CommonStatus,
					o.organizationCode,
					LEFT(o.`OrganizationCode`,LENGTH(o.`OrganizationCode`)-4) as `ParentOrganizationCode`,
					o.organizationName,
					o.SortIndex,
					o.Syscode AS organizationSysCode 
				FROM
					`system_user` s
					LEFT JOIN organization_user ou ON ou.UserSysCode = s.SysCode
					LEFT JOIN organization o ON o.SysCode = ou.OrganizationSysCode 
				WHERE
					s.CommonStatus != - 999 AND s.UserType=@UserType
					#{ AND s.CommonStatus=@CommonStatus }
					#{ AND o.OrganizationCode=@OrganizationCode }
					#{ AND o.OrganizationCode LIKE CONCAT(@LikeOrganizationCode, '%' ) }
					#{ AND (s.LoginName LIKE CONCAT( '%', @Keywords, '%' ) OR s.UserFullName LIKE CONCAT( '%', @Keywords, '%' )) }
				ORDER BY
					ParentOrganizationCode ASC,o.SortIndex DESC,s.SysNo DESC
				]]>
			</Text>
		</SQL>


		<!-- 根据用户syscode获取用户组织信息-->
		<SQL SQLKey="systeUser.GetUserOrganizations" ConnectionKey="MainRead">
			<Text>
				<![CDATA[
				SELECT
					a.`SysNo`,
					a.`SysCode`,
					a.`ParentSysCode`,
					a.`OrganizationCode`,
					a.`OrganizationName`,
					a.`SortIndex`,
					a.`OrganizationShortName`,
					a.`ContactName`,
					a.`ContactPhone`,
					a.`ContactEmail`,
					a.`CommonStatus`,
					b.OrganizationCode AS ParentOrganizationCode,
					b.OrganizationName AS ParentOrganizationName
				FROM
					organization a
					LEFT JOIN organization b ON a.ParentSysCode = b.SysCode
					JOIN organization_user u ON u.OrganizationSysCode = a.SysCode 
				WHERE
					a.CommonStatus != -999
					AND u.UserSysCode = @UserSysCode 
				]]>
			</Text>
		</SQL>
	</SQLList>
</SQLConfig>