<?xml version="1.0" encoding="utf-8"?>
<SQLConfig xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
  <SQLList>
	  <!--项目统计-->
	  <SQL SQLKey="GRStatistics.ProjectStats" ConnectionKey="MainRead">
		  <Text>
			  <![CDATA[
				SELECT
						ProjectSysNo,
					  ProjectName,
						COUNT( DISTINCT BatchSysCode ) DataCount,
						SUM( ExpectedValue ) ExpectedValue,
						SUM( Abs( ActualValue - ActualDeductedValue - ExpectedValue ) / ExpectedValue ) DeviationRate,
						SUM( ActualValue ) ActualValue
				FROM
						(
							SELECT
								GR.ProjectName,
								GR.ProjectSysNo,
								GRB.SysCode BatchSysCode,
								SUM(IFNULL(GRBP.ExpectedValue, 0 ) * IFNULL(GRBP.ExpectedToActualRate, 1 )) ExpectedValue,
								SUM(IFNULL(GRBP.ActualValue, 0 )) ActualValue,
								SUM(IFNULL(GRBP.ActualDeductedValue, 0 )) ActualDeductedValue
							FROM
								goods_receipt GR
								INNER JOIN goods_receipt_batch_product GRBP ON ( GR.SysCode = GRBP.ReceiptSysCode ) 
								INNER JOIN goods_receipt_batch GRB ON(GR.SysCode=GRB.ReceiptSysCode)
								LEFT JOIN goods_carweighinglist CW ON ( CW.BatchSysCode = GRB.SysCode AND CW.WeighingOrder = 1 AND CW.CommonStatus = 1 )
							WHERE
						 		GR.CommonStatus=1
								#{ AND GR.ReceiptStatus IN (@ReceiptStatusList) }
				        #{ AND GR.ProjectSysNo=@ProjectSysNo }
				        #{ AND GR.ProjectSysNo IN(@ProjectSysNoList) }
				        #{ AND GR.ReceiptMode=@ReceiptMode }
				        #{ AND GR.ReceiptType=@ReceiptType }
								#{ AND ((GR.ReceiptMode=2 AND GR.CompleteTime BETWEEN @DateBegin AND @DateEnd) OR (GR.ReceiptMode=1 AND CW.WeighingTime BETWEEN @DateBegin AND @DateEnd)) }
							GROUP BY
								GR.ProjectSysNo,GR.ProjectName,GRB.SysCode
							) T
				GROUP BY
						  ProjectSysNo,ProjectName
				ORDER BY
				      DataCount DESC
				]]>
		  </Text>
	  </SQL>
	  <!--地磅或者移动点验汇总统计-->
	  <SQL SQLKey="GRStatistics.Total" ConnectionKey="MainRead">
		  <Text>
			  <![CDATA[
				SELECT
					   COUNT(DISTINCT BatchSysCode) DataCount,
						 COUNT(DISTINCT ProjectSysNo) ProjectCount,
						 SUM(ExpectedValue) ExpectedValue,
						 SUM(ActualValue) ActualValue,
						 SUM(ActualDeductedValue) ActualDeductedValue
				FROM
					(
						SELECT
						    GRB.SysCode BatchSysCode,
								MAX(GR.ProjectSysNo) ProjectSysNo,
								SUM(IFNULL(GRBP.ExpectedValue, 0 ) * IFNULL(GRBP.ExpectedToActualRate, 1 )) ExpectedValue,
								SUM(IFNULL(GRBP.ActualValue, 0 )) ActualValue,
								SUM(IFNULL(GRBP.ActualDeductedValue, 0 )) ActualDeductedValue
						FROM
								goods_receipt GR
								INNER JOIN goods_receipt_batch_product GRBP ON ( GR.SysCode = GRBP.ReceiptSysCode )
								INNER JOIN goods_receipt_batch GRB ON(GR.SysCode=GRB.ReceiptSysCode)
								LEFT JOIN goods_carweighinglist CW ON ( CW.BatchSysCode = GRB.SysCode AND CW.WeighingOrder = 1 AND CW.CommonStatus = 1 ) 
						WHERE
						    GR.CommonStatus=1 
							  #{ AND GR.ReceiptStatus IN (@ReceiptStatusList) }
				        #{ AND GR.ProjectSysNo = @ProjectSysNo }
				        #{ AND GR.ProjectSysNo IN(@ProjectSysNoList) }
				        #{ AND GR.ReceiptMode=@ReceiptMode }
				        #{ AND GR.ReceiptType=@ReceiptType }
							  #{ AND ((GR.ReceiptMode=2 AND GR.CompleteTime BETWEEN @DateBegin AND @DateEnd) OR (GR.ReceiptMode=1 AND CW.WeighingTime BETWEEN @DateBegin AND @DateEnd)) }
						GROUP BY GRB.SysCode
					) T
				]]>
		  </Text>
	  </SQL>

	  <!--地磅或者移动点验汇总统计-->
	  <SQL SQLKey="GRStatistics.TotalChart" ConnectionKey="MainRead">
		  <Text>
			  <![CDATA[
					SELECT
					   SUM(ExpectedValue) ExpectedValue,
						 SUM(ActualValue) ActualValue,
						 SUM(ActualDeductedValue) ActualDeductedValue,
						 GroupTime
					FROM
						(
						SELECT
								DATE_FORMAT(IFNULL(CW.WeighingTime,GR.CompleteTime), @formatStr) GroupTime,
								SUM(IFNULL(GRBP.ExpectedValue, 0 ) * IFNULL(GRBP.ExpectedToActualRate, 1 )) ExpectedValue,
								SUM(IFNULL(GRBP.ActualValue, 0 )) ActualValue,
								SUM(IFNULL(GRBP.ActualDeductedValue, 0 )) ActualDeductedValue
						FROM
								goods_receipt GR
								INNER JOIN goods_receipt_batch_product GRBP ON ( GR.SysCode = GRBP.ReceiptSysCode )
								INNER JOIN goods_receipt_batch GRB ON(GR.SysCode=GRB.ReceiptSysCode)
								LEFT JOIN goods_carweighinglist CW ON ( CW.BatchSysCode = GRB.SysCode AND CW.WeighingOrder = 1 AND CW.CommonStatus = 1 ) 
						WHERE
						    GR.CommonStatus=1 
								#{ AND GR.ReceiptStatus IN (@ReceiptStatusList) }
				        #{ AND GR.ProjectSysNo=@ProjectSysNo }
				        #{ AND GR.ProjectSysNo IN(@ProjectSysNoList) }
				        #{ AND GR.ReceiptMode=@ReceiptMode }
				        #{ AND GR.ReceiptType=@ReceiptType }
								#{ AND ((GR.ReceiptMode=2 AND GR.CompleteTime BETWEEN @DateBegin AND @DateEnd) OR (GR.ReceiptMode=1 AND CW.WeighingTime BETWEEN @DateBegin AND @DateEnd)) }
						GROUP BY
					      GRB.SysCode
						) T
				GROUP BY
						GroupTime
				ORDER BY
						GroupTime
				]]>
		  </Text>
	  </SQL>

	  <!--地磅或者移动点验材料商品分页统计-->
	  <SQL SQLKey="GRStatistics.Product.Count" ConnectionKey="MainRead">
		  <Text>
			  <![CDATA[
					SELECT
					  ProductName,
						ProductSysCode,
					  COUNT( DISTINCT BatchSysCode ) DataCount,
						SUM( ActualValue ) ActualValue,
						SUM( ActualDeductedValue ) ActualDeductedValue,
						SUM( ExpectedValue ) ExpectedValue,
						SUM( ActualValue - ActualDeductedValue - ExpectedValue ) / SUM( ExpectedValue ) DeviationRate 
					FROM
						(
						SELECT
								GRBP.ProductSysCode,
								GRBP.ProductName,
								GRB.SysCode BatchSysCode,
               	SUM(IFNULL(GRBP.ExpectedValue, 0 ) * IFNULL(GRBP.ExpectedToActualRate, 1 )) ExpectedValue,
								SUM(IFNULL(GRBP.ActualValue, 0 )) ActualValue,
								SUM(IFNULL(GRBP.ActualDeductedValue, 0 )) ActualDeductedValue
						FROM
								goods_receipt GR
								INNER JOIN goods_receipt_batch_product GRBP ON ( GR.SysCode = GRBP.ReceiptSysCode )
								INNER JOIN goods_receipt_batch GRB ON(GR.SysCode=GRB.ReceiptSysCode)
                LEFT JOIN goods_carweighinglist CW ON ( CW.BatchSysCode = GRB.SysCode AND CW.WeighingOrder = 1 AND CW.CommonStatus = 1 ) 
						WHERE
						    GR.CommonStatus=1 
								#{ AND GR.ReceiptStatus IN (@ReceiptStatusList) }
				        #{ AND GR.ProjectSysNo=@ProjectSysNo }
				        #{ AND GR.ProjectSysNo IN(@ProjectSysNoList) }
				        #{ AND GR.ReceiptMode=@ReceiptMode }
				        #{ AND GR.ReceiptType=@ReceiptType }
								#{ AND GR.SupplierSysCode=@SupplierSysCode }
                #{ AND GRBP.ProductName LIKE CONCAT('%',@Keywords,'%') }
								#{ AND ((GR.ReceiptMode=2 AND GR.CompleteTime BETWEEN @DateBegin AND @DateEnd) OR (GR.ReceiptMode=1 AND CW.WeighingTime BETWEEN @DateBegin AND @DateEnd)) }
						GROUP BY
							  GRBP.ProductSysCode,GRBP.ProductName,GRB.SysCode
						) T
				GROUP BY
						ProductSysCode,ProductName
				ORDER BY
						ExpectedValue DESC
				]]>
		  </Text>
	  </SQL>

	  <!--供应商分页统计-->
	  <SQL SQLKey="GRStatistics.Supplier.Count" ConnectionKey="MainRead">
		  <Text>
			  <![CDATA[
					SELECT
					  SupplierName,
						SupplierSysCode,
					  COUNT( DISTINCT BatchSysCode ) DataCount,
						SUM( ActualValue ) ActualValue,
						SUM( ActualDeductedValue ) ActualDeductedValue,
						SUM( ExpectedValue ) ExpectedValue,
						SUM( ActualValue - ActualDeductedValue - ExpectedValue ) / SUM( ExpectedValue ) DeviationRate
					FROM
						(
						SELECT
								GR.SupplierName,
								GR.SupplierSysCode,
						  	GRB.SysCode BatchSysCode,
								SUM(IFNULL(GRBP.ExpectedValue, 0 ) * IFNULL(GRBP.ExpectedToActualRate, 1 )) ExpectedValue,
								SUM(IFNULL(GRBP.ActualValue, 0 )) ActualValue,
								SUM(IFNULL(GRBP.ActualDeductedValue, 0 )) ActualDeductedValue
						FROM
								goods_receipt GR
								INNER JOIN goods_receipt_batch_product GRBP ON ( GR.SysCode = GRBP.ReceiptSysCode )
								INNER JOIN goods_receipt_batch GRB ON(GR.SysCode=GRB.ReceiptSysCode)
								LEFT JOIN goods_carweighinglist CW ON ( CW.BatchSysCode = GRB.SysCode AND CW.WeighingOrder = 1 AND CW.CommonStatus = 1 ) 
						WHERE
						    GR.CommonStatus=1 
								#{ AND GR.ReceiptStatus IN (@ReceiptStatusList) }
				        #{ AND GR.ProjectSysNo=@ProjectSysNo }
				        #{ AND GR.ProjectSysNo IN(@ProjectSysNoList) }
				        #{ AND GR.ReceiptMode=@ReceiptMode }
				        #{ AND GR.ReceiptType=@ReceiptType }
								#{ AND ((GR.ReceiptMode=2 AND GR.CompleteTime BETWEEN @DateBegin AND @DateEnd) OR (GR.ReceiptMode=1 AND CW.WeighingTime BETWEEN @DateBegin AND @DateEnd)) }
						GROUP BY
							  GR.SupplierSysCode,GR.SupplierName,GRB.SysCode
						) T
				GROUP BY
						SupplierSysCode,SupplierName
				ORDER BY
						ExpectedValue DESC
				]]>
		  </Text>
	  </SQL>

	  <!--车辆分页统计-->
	  <SQL SQLKey="GRStatistics.Car.Count" ConnectionKey="MainRead">
		  <Text>
			  <![CDATA[
					SELECT
					  PlateNumber,
					  COUNT( DISTINCT BatchSysCode ) DataCount,
						MAX( MaxTareWeight ) MaxTareWeight,
						MIN( MinTareWeight ) MinTareWeight,
						SUM( TareWeight ) TareWeight,
						SUM( ActualValue ) ActualValue,
						SUM( ActualDeductedValue ) ActualDeductedValue,
						SUM( ExpectedValue ) ExpectedValue,
						SUM( ActualValue - ActualDeductedValue - ExpectedValue ) / SUM( ExpectedValue ) DeviationRate 
					FROM
						(
						SELECT
								GRB.PlateNumber,
						  	GRB.SysCode BatchSysCode,
								MAX( GRB.TareWeight ) MaxTareWeight,
								MIN( GRB.TareWeight ) MinTareWeight,
								MAX( GRB.TareWeight ) TareWeight,
								SUM(IFNULL(GRBP.ExpectedValue, 0 ) * IFNULL(GRBP.ExpectedToActualRate, 1 )) ExpectedValue,
								SUM(IFNULL(GRBP.ActualValue, 0 )) ActualValue,
								SUM(IFNULL(GRBP.ActualDeductedValue, 0 )) ActualDeductedValue
						FROM
								goods_receipt GR
								INNER JOIN goods_receipt_batch_product GRBP ON ( GR.SysCode = GRBP.ReceiptSysCode )
								INNER JOIN goods_receipt_batch GRB ON(GR.SysCode=GRB.ReceiptSysCode)
								INNER JOIN goods_carweighinglist CW ON ( CW.BatchSysCode = GRB.SysCode AND CW.WeighingOrder = 1 AND CW.CommonStatus = 1 ) 
						WHERE
						    GR.CommonStatus=1 
								#{ AND GR.ReceiptStatus IN (@ReceiptStatusList) }
				        #{ AND GR.ProjectSysNo=@ProjectSysNo }
				        #{ AND GR.ProjectSysNo IN(@ProjectSysNoList) }
				        #{ AND GR.ReceiptMode=@ReceiptMode }
				        #{ AND GR.ReceiptType=@ReceiptType }
								#{ AND GRB.PlateNumber LIKE CONCAT('%',@Keywords,'%') }
								#{ AND (CW.WeighingTime BETWEEN @DateBegin AND @DateEnd) }
						GROUP BY
							 GRB.PlateNumber,GRB.SysCode
						) T
				GROUP BY
						PlateNumber
				ORDER BY
						DataCount DESC
				]]>
		  </Text>
	  </SQL>
  </SQLList>
</SQLConfig>
